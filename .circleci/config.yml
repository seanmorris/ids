version: 2.1

commands:
  install-composer:
    steps:
      - run: |
          sudo apt install -y software-properties-common
          sudo add-apt-repository -y ppa:ondrej/php
          sudo apt-get update
          sudo apt-get install -y php7.4-cli php7.4-common php7.4-mbstring php7.4-intl php7.4-zip php7.4-bcmath php7.4-dom
          curl -s https://getcomposer.org/installer | php
          sudo mv composer.phar /usr/local/bin/composer

workflows:
  version: 2

  build-test-push:
    jobs:
      - init-test
      - recursive-test-1
      - self-test:
          requires:
            - init-test
      - build-and-push:
          requires:
            - recursive-test-1
            - self-test
            - init-test

  build-test-push_7-1:
    jobs:
      - init-test_7-1
      - recursive-test-1_7-1
      - self-test_7-1:
          requires:
            - init-test_7-1
      - build-and-push_7-1:
          requires:
            - recursive-test-1_7-1
            - self-test_7-1
            - init-test_7-1

  build-test-push_7-2:
    jobs:
      - init-test_7-2
      - recursive-test-1_7-2
      - self-test_7-2:
          requires:
            - init-test_7-2
      - build-and-push_7-2:
          requires:
            - recursive-test-1_7-2
            - self-test_7-2
            - init-test_7-2

  build-test-push_7-3:
    jobs:
      - init-test_7-3
      - recursive-test-1_7-2
      - self-test_7-3:
          requires:
            - init-test_7-3
      - build-and-push_7-3:
          requires:
            - self-test_7-3
            - init-test_7-3

  build-test-push_7-4:
    jobs:
      - init-test_7-4
      - recursive-test-1_7-4
      - self-test_7-4:
          requires:
            - init-test_7-4
      - build-and-push_7-4:
          requires:
            - recursive-test-1_7-4
            - self-test_7-4
            - init-test_7-4

jobs:

  init-test:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer create-project seanmorris/ids-project -s dev --remove-vcs
      - run: |
          cd ids-project \
          && composer require seanmorris/ids:dev-${CIRCLE_BRANCH} \
          && make @test start-bg test

  init-test_7-1:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer create-project seanmorris/ids-project -s dev --remove-vcs
      - run: |
          cd ids-project \
          && composer require seanmorris/ids:dev-${CIRCLE_BRANCH} \
          && PHP=7.1 make @test start-bg test

  init-test_7-2:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: composer create-project seanmorris/ids-project -s dev --remove-vcs
      - run: |
          cd ids-project \
          && composer require seanmorris/ids:dev-${CIRCLE_BRANCH} \
          && PHP=7.2 make @test start-bg test

  init-test_7-3:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer create-project seanmorris/ids-project -s dev --remove-vcs
      - run: |
          cd ids-project \
          && composer require seanmorris/ids:dev-${CIRCLE_BRANCH} \
          && PHP=7.3 make @test start-bg test

  init-test_7-4:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer create-project seanmorris/ids-project -s dev --remove-vcs
      - run: |
          cd ids-project \
          && composer require seanmorris/ids:dev-${CIRCLE_BRANCH} \
          && PHP=7.4 make @test start-bg test

  self-test:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: make @base ct b
      - run: make @dev ct b
      - run: make @prod ct b
      - run: make @test ct b
      - run: make @base ct b
      - run: make @test ct b t lt li
      - run: make stay@dev ct b lt li
      - run: make @prod ct b
      - run: make ct b
      - run: make @test ct b t
      - run: make stay@base ct b
      - run: make ct b

  self-test_7-1:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: PHP=7.1 make @base ct b
      - run: PHP=7.1 make @dev ct b
      - run: PHP=7.1 make @prod ct b
      - run: PHP=7.1 make @test ct b
      - run: PHP=7.1 make @base ct b
      - run: PHP=7.1 make @test ct b t lt li
      - run: PHP=7.1 make stay@dev ct b lt li
      - run: PHP=7.1 make @prod ct b
      - run: PHP=7.1 make ct b
      - run: PHP=7.1 make @test ct b t
      - run: PHP=7.1 make stay@base ct b
      - run: PHP=7.1 make ct b

  self-test_7-2:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: PHP=7.2 make @base ct b
      - run: PHP=7.2 make @dev ct b
      - run: PHP=7.2 make @prod ct b
      - run: PHP=7.2 make @test ct b
      - run: PHP=7.2 make @base ct b
      - run: PHP=7.2 make @test ct b t lt li
      - run: PHP=7.2 make stay@dev ct b lt li
      - run: PHP=7.2 make @prod ct b
      - run: PHP=7.2 make ct b
      - run: PHP=7.2 make @test ct b t
      - run: PHP=7.2 make stay@base ct b
      - run: PHP=7.2 make ct b

  self-test_7-3:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: PHP=7.3 make @base ct b
      - run: PHP=7.3 make @dev ct b
      - run: PHP=7.3 make @prod ct b
      - run: PHP=7.3 make @test ct b
      - run: PHP=7.3 make @base ct b
      - run: PHP=7.3 make @test ct b t lt li
      - run: PHP=7.3 make stay@dev ct b lt li
      - run: PHP=7.3 make @prod ct b
      - run: PHP=7.3 make ct b
      - run: PHP=7.3 make @test ct b t
      - run: PHP=7.3 make stay@base ct b
      - run: PHP=7.3 make ct b

  self-test_7-4:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: PHP=7.4 make @base ct b
      - run: PHP=7.4 make @dev ct b
      - run: PHP=7.4 make @prod ct b
      - run: PHP=7.4 make @test ct b
      - run: PHP=7.4 make @base ct b
      - run: PHP=7.4 make @test ct b t lt li
      - run: PHP=7.4 make stay@dev ct b lt li
      - run: PHP=7.4 make @prod ct b
      - run: PHP=7.4 make ct b
      - run: PHP=7.4 make @test ct b t
      - run: PHP=7.4 make stay@base ct b
      - run: PHP=7.4 make ct b

  recursive-test-1:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - setup_remote_docker
      - checkout
      - install-composer
      - run: composer install
      - run: make @test+make ct b run CMD="make @test test"

  recursive-test-1_7-1:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - setup_remote_docker
      - checkout
      - install-composer
      - run: composer install
      - run: PHP=7.1 make @test+make ct b run CMD="make @test test"

  recursive-test-1_7-2:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - setup_remote_docker
      - checkout
      - install-composer
      - run: composer install
      - run: PHP=7.2 make @test+make ct b run CMD="make @test test"

  recursive-test-1_7-3:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - setup_remote_docker
      - checkout
      - install-composer
      - run: composer install
      - run: PHP=7.3 make @test+make ct b run CMD="make @test test"

  recursive-test-1_7-4:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - setup_remote_docker
      - checkout
      - install-composer
      - run: composer install
      - run: PHP=7.4 make @test+make ct b run CMD="make @test test"

  build-and-push:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: make @base ct b psi
      - run: make @dev  ct b psi
      - run: make @prod ct b psi
      - run: make @test ct b psi

  build-and-push_7-1:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: PHP=7.1 make @base ct b psi
      - run: PHP=7.1 make @dev  ct b psi
      - run: PHP=7.1 make @prod ct b psi
      - run: PHP=7.1 make @test ct b psi

  build-and-push_7-2:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: PHP=7.2 make @base ct b psi
      - run: PHP=7.2 make @dev  ct b psi
      - run: PHP=7.2 make @prod ct b psi
      - run: PHP=7.2 make @test ct b psi

  build-and-push_7-3:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: PHP=7.3 make @base ct b psi
      - run: PHP=7.3 make @dev  ct b psi
      - run: PHP=7.3 make @prod ct b psi
      - run: PHP=7.3 make @test ct b psi

  build-and-push_7-4:
    parallelism: 1
    docker:
      - image: circleci/php:7.4.1
    steps:
      - checkout
      - install-composer
      - run: composer install
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: PHP=7.4 make @base ct b psi
      - run: PHP=7.4 make @dev  ct b psi
      - run: PHP=7.4 make @prod ct b psi
      - run: PHP=7.4 make @test ct b psi
