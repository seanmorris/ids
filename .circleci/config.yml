version: 2
workflows:
  version: 2
  build_and_test:
    jobs:
      - test
      - test-7.1
      - test-7.2
      - test-7.3
      - test-7.4
      - test-7.4
      - build
      - build-7.1
      - build-7.2
      - build-7.3
      - build-7.4
      - build-7.4
jobs:

  test:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: make @base ct b
      - run: make stay@dev ct b lt li
      - run: make @test ct b t lt li
      - run: make @prod ct b
      - run: make ct b
      - run: make @test ct b t
      - run: make stay@base ct b
      - run: make ct b

  test-7.1:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: PHP=7.1 make @base ct b
      - run: PHP=7.1 make @dev ct b
      - run: PHP=7.1 make @prod ct b
      - run: PHP=7.1 make @test ct b
      - run: PHP=7.1 make @base ct b
      - run: PHP=7.1 make @test ct b t lt li
      - run: PHP=7.1 make stay@dev ct b lt li
      - run: PHP=7.1 make @prod ct b
      - run: PHP=7.1 make ct b
      - run: PHP=7.1 make @test ct b t
      - run: PHP=7.1 make stay@base ct b
      - run: PHP=7.1 make ct b

  test-7.2:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: PHP=7.2 make @base ct b
      - run: PHP=7.2 make @dev ct b
      - run: PHP=7.2 make @prod ct b
      - run: PHP=7.2 make @test ct b
      - run: PHP=7.2 make @base ct b
      - run: PHP=7.2 make @test ct b t lt li
      - run: PHP=7.2 make stay@dev ct b lt li
      - run: PHP=7.2 make @prod ct b
      - run: PHP=7.2 make ct b
      - run: PHP=7.2 make @test ct b t
      - run: PHP=7.2 make stay@base ct b
      - run: PHP=7.2 make ct b

  test-7.3:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: PHP=7.3 make @base ct b
      - run: PHP=7.3 make @dev ct b
      - run: PHP=7.3 make @prod ct b
      - run: PHP=7.3 make @test ct b
      - run: PHP=7.3 make @base ct b
      - run: PHP=7.3 make @test ct b t lt li
      - run: PHP=7.3 make stay@dev ct b lt li
      - run: PHP=7.3 make @prod ct b
      - run: PHP=7.3 make ct b
      - run: PHP=7.3 make @test ct b t
      - run: PHP=7.3 make stay@base ct b
      - run: PHP=7.3 make ct b

  test-7.4:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: PHP=7.4 make @base ct b
      - run: PHP=7.4 make @dev ct b
      - run: PHP=7.4 make @prod ct b
      - run: PHP=7.4 make @test ct b
      - run: PHP=7.4 make @base ct b
      - run: PHP=7.4 make @test ct b t lt li
      - run: PHP=7.4 make stay@dev ct b lt li
      - run: PHP=7.4 make @prod ct b
      - run: PHP=7.4 make ct b
      - run: PHP=7.4 make @test ct b t
      - run: PHP=7.4 make stay@base ct b
      - run: PHP=7.4 make ct b

  build:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: make @base ct b psi
      - run: make @dev ct b  psi
      - run: make @prod ct b psi
      - run: make @test ct b psi

  build-7.1:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: PHP=7.1 make @base ct b psi
      - run: PHP=7.1 make @dev ct b  psi
      - run: PHP=7.1 make @prod ct b psi
      - run: PHP=7.1 make @test ct b psi

  build-7.2:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: PHP=7.2 make @base ct b psi
      - run: PHP=7.2 make @dev ct b  psi
      - run: PHP=7.2 make @prod ct b psi
      - run: PHP=7.2 make @test ct b psi

  build-7.3:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: PHP=7.3 make @base ct b psi
      - run: PHP=7.3 make @dev ct b  psi
      - run: PHP=7.3 make @prod ct b psi
      - run: PHP=7.3 make @test ct b psi

  build-7.4:
    parallelism: 2
    machine:
      image: ubuntu-1604:201903-01
    steps:
      - checkout
      - run: echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
      - run: PHP=7.4 make @base ct b psi
      - run: PHP=7.4 make @dev ct b  psi
      - run: PHP=7.4 make @prod ct b psi
      - run: PHP=7.4 make @test ct b psi
