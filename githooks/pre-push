#!/bin/bash
set -eux;

while read -d $'\0' VAR ; do declare "$VAR"; done < <(make env SEP=-0);

[[ "$TARGET" == "test" ]] && set +x;

echo $BRANCH;

while read LINE; do echo $LINE | {
	IFS=":" read BRANCH TARGET

	echo "$BRANCH:$TARGET found in .publishing file. Ids is building & pushing now.";

	make TARGET=$TARGET;
	make TARGET=$TARGET push-images;

}; done < <(grep ^$BRANCH\: .publishing);
