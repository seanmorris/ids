#!/bin/bash

set -u;

PHP_ERROR=0;
git diff-index HEAD \
	| grep ".php" \
	| grep "^:"   \
	| sed 's:.* [UAM][ \\''t]*\([^ \\''t]*\):\1:g' \
	| while read FILE; do \
		echo Checking $FILE...;
		echo -ne "\t";
		php -l $FILE 2>&1;
		[[ 0 -ne  $? ]] && PHP_ERROR=1;
	done;

set -eu;

[[ 1 -ne $PHP_ERROR ]] \
	&& echo Please correct the above errors before committing. \
	&& exit $PHP_ERROR;

make TARGET=base
make TARGET=dev
make TARGET=test

make test TARGET=test
