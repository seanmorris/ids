#!/usr/bin/env php
<?php
use \SeanMorris\Ids\Path;
use \SeanMorris\Ids\Router;
use \SeanMorris\Ids\Idilic\Route\RootRoute;

ini_set('display_errors', TRUE);

array_shift($argv);

$requestProto = new stdClass;
$requests = [];
$requests[] =& $requestProto;
$requestProto->args = $args = [];
$requestProto->switches = $switches = [];

$input = [];

if($argv)
{
	$input = $argv;
}
else
{
	// while($line = fgets(STDIN))
	// {
	// 	$line    = trim($line);
	// 	if(!$line)
	// 	{
	// 		continue;
	// 	}
	// 	$input[] = trim($line);
	// 	$input[] = '---';
	// }
}

foreach($input as $arg)
{
	if(preg_match('/^---$/', $arg))
	{
		if(!$args)
		{
			//continue;
		}

		$requestProto->args = $args;
		$requestProto->switches = $switches;
		$args = [];
		$switches = [];

		$requests[] = new stdClass;
		$requestProto =& $requests[count($requests) - 1];

		continue;
	}

	if(!preg_match('/^(-+?)(\w+)\s?=?\s?(\S+)?$/', $arg, $match))
	{
		$args[] = $arg;
	}
	else
	{
		$type = $match[1];
		$switch = $match[2];
		$value = isset($match[3])
			? $match[3]
			: TRUE;

		$switches[$switch] = $value;
	}

	$requestProto->args = $args;
	$requestProto->switches = $switches;
}

$composer = require dirname(__FILE__) . '/../init.php';

$_SERVER['HTTP_HOST'] = \SeanMorris\Ids\Settings::read('default', 'domain');

if(isset($switches['d']))
{
	$_SERVER['HTTP_HOST'] = $switches['d'];
}

if(isset($switches['domain']))
{
	$_SERVER['HTTP_HOST'] = $switches['domain'];
}

foreach($requests as $req)
{
	$request = new \SeanMorris\Ids\Request([
		'path' => $path = new Path(...$req->args ?? [])
		, 'switches' => $req->switches ?? NULL
	]);

	$routes = new RootRoute;
	$router = new Router($request, $routes);
	$res = $router->route();

	if(!is_scalar($res) && $res !== null)
	{
		print json_encode($res, JSON_PRETTY_PRINT);
	}
	else
	{
		print $res;
	}

	print PHP_EOL;
}
